#!/usr/bin/env python3
import os
import subprocess
import configparser


def get_plugin_credentials(plugin_dir):
    config = configparser.ConfigParser()
    config.read(os.path.join(plugin_dir, 'plugin.credentials'))
    section = config['credentials']

    return {
        'username': section.get('username'),
        'password': section.get('password'),
    }


def set_plugin_credentials(credentials):
    username = credentials['username']
    password = credentials['password']

    subprocess.check_call(['rabbitmqctl', 'status'])

    try:
        subprocess.check_call([
            'rabbitmqctl',
            'authenticate_user',
            username,
            password])
        print('Plugin credentials up-to-date.')
        return
    except subprocess.CalledProcessError:
        print('Plugin credentials will be updated.')

    try:
        subprocess.check_call([
            'rabbitmqctl',
            'add_user',
            username,
            password])
    except subprocess.CalledProcessError:
        subprocess.check_call([
            'rabbitmqctl',
            'change_password',
            username,
            password])

    queue = 'to-' + username
    configure = '^{}$'.format(queue)
    write = '^publish$'
    read = '^{}$'.format(queue)

    subprocess.check_call([
        'rabbitmqctl',
        'set_permissions',
        username,
        configure,
        write,
        read])

    print('Plugin credentials updated.')


def main():
    credentials = get_plugin_credentials('.')
    set_plugin_credentials(credentials)


if __name__ == '__main__':
    main()
